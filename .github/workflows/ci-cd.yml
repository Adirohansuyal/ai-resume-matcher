name: AI App Production CI/CD

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install Dependencies
      run: pip install -r requirements.txt

    - name: Run Tests
      run: python test_app.py

    # üîπ Docker Login
    - name: Docker Login
      run: |
        echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login \
        -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    # üîπ Build with VERSION TAG
    - name: Build & Push Docker Image
      run: |
        TAG=${{ github.sha }}
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/ai-resume-matcher:$TAG .
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/ai-resume-matcher:$TAG
        echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV

    # üîπ BLUE-GREEN DEPLOY
    - name: Zero Downtime Deploy
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          set -e

          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/ai-resume-matcher:${IMAGE_TAG}

          # Decide next container
          if docker ps | grep ai-app-blue; then
            NEW=green
            OLD=blue
          else
            NEW=blue
            OLD=green
          fi

          docker run -d \
            --name ai-app-$NEW \
            -p 8501:8501 \
            ${{ secrets.DOCKERHUB_USERNAME }}/ai-resume-matcher:${IMAGE_TAG}

          sleep 15

          # Health check
          if ! docker inspect --format='{{.State.Health.Status}}' ai-app-$NEW | grep healthy; then
            echo "‚ùå New container unhealthy. Rolling back..."
            docker rm -f ai-app-$NEW
            exit 1
          fi

          docker rm -f ai-app-$OLD || true
